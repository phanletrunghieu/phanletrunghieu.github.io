<!DOCTYPE html><html><head><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel="stylesheet"/><title>Microservice - Hlog - Code for fun</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Cùng nhau chia sẻ kinh nghiệm, mò mẫm kiến thức mới"/><meta property="og:type" content="article"/><meta property="og:title" content="Microservice - Hlog - Code for fun"/><meta property="og:description" content="Cùng nhau chia sẻ kinh nghiệm, mò mẫm kiến thức mới"/><meta property="og:image" content="http://static01.nyt.com/images/2015/02/19/arts/international/19iht-btnumbers19A/19iht-btnumbers19A-facebookJumbo-v2.jpg"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/8537a22d1fe977ad51c0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8537a22d1fe977ad51c0.css"/><link rel="preload" href="/_next/static/css/e87fe1761b82e15598e0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e87fe1761b82e15598e0.css"/><link rel="preload" href="/_next/static/LUWioLlLulu8RWrhGUiG9/pages/category/%5B...slug%5D.js" as="script"/><link rel="preload" href="/_next/static/LUWioLlLulu8RWrhGUiG9/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-b65cab0b00afd201cbda.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.2689030919a9ba0449ff.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.d3a5cad3addbd9214ed4.js" as="script"/><link rel="preload" href="/_next/static/chunks/69458a142e105b0d8bbea83998db9bb925089155.e0b3d670b033b1889366.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-27122c53c6c061494a08.js" as="script"/><link rel="preload" href="/_next/static/chunks/4b5d35de3ec6426d4db57841c6c1b4b124768f5b.1cf5cae86f3d15225359.js" as="script"/></head><body><div id="__next"><div><div><div class="Header_container__13qZs"><h2 class="Header_logo__1ZEvY">Hlog</h2><div><span class="Header_category__10c-V">ReactJS</span><span class="Header_category__10c-V">K8s</span><span class="Header_category__10c-V">Docker</span><span class="Header_category__10c-V">GI/CD</span><span class="Header_category__10c-V">Tip</span><span class="Header_category__10c-V">Gitlab</span><span class="Header_categoryActive__1aqxb">Microservice</span></div><div></div></div><div style="margin-top:80px"><div class="PostBox_container__32pag"><div class="PostBox_imageContainer__2Jypf" style="background-image:url(&#x27;/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/cover.jpg&#x27;)"></div><div class="PostBox_contentContainer__1gRO0"><header class="PostBox_header__2NRif"><h1>Quản lý log tập trung trong microservice với ELK. Phần 1: trên docker swarm</h1><p class="PostBox_date__3AxRV">Jun 22 2020</p><span class="PostBox_readDuration__1I_Hy">30 min</span></header><div class="PostBox_body__2m5Fb"><h2>1. Kiến trúc</h2><p><img alt="List node" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/architect.png"/></p><h2>2. Khởi tạo docker swarm</h2><p>Bạn có thể dùng nhiều server có cài sẵn docker để tạo thành 1 c</p></div></div></div></div><div class="Paginator_container__1ZAnr"><a class="Paginator_buttonDisable__15pRs">&lt;</a><a class="Paginator_buttonActive__HUihv">1</a><a class="Paginator_buttonDisable__15pRs">&gt;</a></div><div><div class="Footer_content__3hdD7"><div class="Footer_logo__2F2BD">Hlog</div><div class="Footer_iconContainer__3ouva"><a target="_blank" href="https://github.com/phanletrunghieu"><svg class="Footer_logoSvg__XMKMu" data-prefix="fab" data-icon="github-square" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"></path></svg></a><a target="_blank" href="https://www.linkedin.com/in/phanletrunghieu"><svg class="Footer_logoSvg__XMKMu" data-prefix="fab" data-icon="linkedin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a target="_blank" href="https://www.facebook.com/phanletrunghieu"><svg class="Footer_logoSvg__XMKMu" data-prefix="fab" data-icon="facebook-square" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48A48 48 0 0 0 0 80v352a48 48 0 0 0 48 48h137.25V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.27c-30.81 0-40.42 19.12-40.42 38.73V256h68.78l-11 71.69h-57.78V480H400a48 48 0 0 0 48-48V80a48 48 0 0 0-48-48z"></path></svg></a></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"microservice","categories":["ReactJS","K8s","Docker","GI/CD","Tip","Gitlab","Microservice"],"allBlogs":[{"frontmatter":{"author":"Hieu Phan","date":"2020-06-22T15:22:00.000Z","image":"/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/cover.jpg","title":"Quản lý log tập trung trong microservice với ELK. Phần 1: trên docker swarm","readDuration":"30 min","categories":["Docker","Microservice"]},"markdownBody":"\n## 1. Kiến trúc\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/architect.png)\n\n## 2. Khởi tạo docker swarm\n\nBạn có thể dùng nhiều server có cài sẵn docker để tạo thành 1 cluster. Tốt nhất là docker cùng version để tránh gặp những lỗi tào lao. Trong bài viết này mình dùng docker-machine để giả lập 3 node để demo.\n\n### 2.1. Tạo 1 cluster với 3 node\n\n```bash\ndocker-machine create -d virtualbox --virtualbox-memory \"2048\" node1\ndocker-machine create -d virtualbox --virtualbox-memory \"1024\" node2\ndocker-machine create -d virtualbox --virtualbox-memory \"1024\" node3\n```\n\nFixing `out of memory` error of Elasticsearch\n\n```bash\ndocker-machine ssh node1 sudo sysctl -w vm.max_map_count=262144\ndocker-machine ssh node2 sudo sysctl -w vm.max_map_count=262144\ndocker-machine ssh node3 sudo sysctl -w vm.max_map_count=262144\n```\n\nKiểm tra các node đã tạo\n\n```bash\ndocker-machine ls\n```\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/1-list-node.png)\n\n### 2.2. Cho `node1` làm node manager.\n\n```bash\ndocker-machine ssh node1\ndocker swarm init --advertise-addr 192.168.99.104\n```\n\n`192.168.99.104` là ip của node 1, đã kiểm tra ở trên.\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/2-init-swarm.png)\n\nKết quả ở trên cho ta 1 command để các node khác có thể join vào cluster.\n\n### 2.3. Join các node còn lại vào cluster\n\nTa lần lượt ssh vào từng node và chạy lệnh join ở trên.\n\n```bash\ndocker-machine ssh node2\ndocker swarm join --token SWMTKN-1-5dk4ysohsctxbifjmb6x8xa5i6qps81au5k4fmzzqmne3l3oz0-ac99bh5vrw8zm3lychgpu3cwh 192.168.99.104:2377\n```\n\n```bash\ndocker-machine ssh node3\ndocker swarm join --token SWMTKN-1-5dk4ysohsctxbifjmb6x8xa5i6qps81au5k4fmzzqmne3l3oz0-ac99bh5vrw8zm3lychgpu3cwh 192.168.99.104:2377\n```\n\n\u003e Chú ý: `token` trong lệnh `docker swarm join` sẽ khác nhau ở mỗi lần chạy. Nên chỗ này đừng copy của mình nhé. Lỗi đấy!\n\n## 3. Deploy ELK lên docker swarm\n\nSSH vào node manager `docker-machine ssh node1`.\n\nTạo 1 file `docker-stack.yml` có nội dung như sau:\n\n```yaml\nversion: '3'\n\nservices:\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0\n    ports:\n      - \"9200:9200\"\n    volumes:\n      - esdata:/usr/share/elasticsearch/data\n    environment:\n      ES_JAVA_OPTS: \"-Xmx256m -Xms256m\"\n      ELASTIC_PASSWORD: \"changeme\"\n      discovery.type: single-node\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  logstash:\n    image: docker.elastic.co/logstash/logstash:7.8.0\n    volumes:\n      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf\n    depends_on:\n      - elasticsearch\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.8.0\n    environment:\n      ELASTICSEARCH_HOSTS: 'http://elasticsearch:9200'\n    ports:\n      - \"5601:5601\"\n    depends_on:\n      - logstash\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  logspout:\n    image: gliderlabs/logspout:v3\n    command: 'udp://logstash:5000'\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n    depends_on:\n      - logstash\n    deploy:\n      mode: global\n      restart_policy:\n        condition: on-failure\n        delay: 30s\n\n  visualizer:\n    image: dockersamples/visualizer:stable\n    ports:\n      - \"8081:8080\"\n    volumes:\n      - \"/var/run/docker.sock:/var/run/docker.sock\"\n    labels:\n      app: \"visualizer\"\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\nvolumes:\n  esdata:\n    driver: local\n```\n\nTạo 1 file `logstash.conf` có nội dung như sau:\n\n```\ninput {\n   udp {\n   \t\tport =\u003e 5000\n   \t\tcodec =\u003e json\n   \t}\n}\n\n## Add your filters / logstash plugins configuration here\n\nfilter {\n  if [docker][image] =~ /logstash/ {\n    drop { }\n  }\n}\n\noutput {\n    elasticsearch {\n      hosts =\u003e \"elasticsearch:9200\"\n      user =\u003e \"elastic\"\n      password =\u003e \"changeme\"\n    }\n\n    stdout { codec =\u003e rubydebug }\n}\n```\n\nTiến hành deploy\n\n```bash\ndocker stack deploy -c docker-stack.yml elk\n```\n\nThường mình sẽ gặp 1 lỗi là logspout sẽ không kết nối được đến logstash, do logstash chưa init xong. Bạn hãy đợi 1 thời gian rồi chạy `docker service update --force elk_logspout` để restart lại logspout trên các node.\n\n## 4. Xem log từ Kibana\n\nDùng browser truy cập vào 1 node bất kỳ trong swarm với port `5601`\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/1-list-node.png)\n\nTrong trường hợp của mình, mình sẽ truy cập vào `http://192.168.99.104:5601`.\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/3-kibana-1.jpg)\n\nTạo 1 index pattern `logstash*`\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/4-kibana-2.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/5-kibana-3.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/6-kibana-4.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/7-kibana-5.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/8-kibana-6.png)\n\nOke! Tới đây giao diện để truy xuất log đã hiện ra. Bạn có thể filter log theo thời gian, theo app,... Chỗ này bạn có thể tự mò nhé, giao diện kibana cũng khá dễ sử dụng.","slug":"6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm"}],"title":"Hlog - Code for fun","description":"Cùng nhau chia sẻ kinh nghiệm, mò mẫm kiến thức mới","currentPage":1,"totalPage":1},"__N_SSG":true},"page":"/category/[...slug]","query":{"slug":["microservice"]},"buildId":"LUWioLlLulu8RWrhGUiG9","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-16ccf9440fd1c9275fd4.js"></script><script async="" data-next-page="/category/[...slug]" src="/_next/static/LUWioLlLulu8RWrhGUiG9/pages/category/%5B...slug%5D.js"></script><script async="" data-next-page="/_app" src="/_next/static/LUWioLlLulu8RWrhGUiG9/pages/_app.js"></script><script src="/_next/static/runtime/webpack-b65cab0b00afd201cbda.js" async=""></script><script src="/_next/static/chunks/framework.2689030919a9ba0449ff.js" async=""></script><script src="/_next/static/chunks/commons.d3a5cad3addbd9214ed4.js" async=""></script><script src="/_next/static/chunks/69458a142e105b0d8bbea83998db9bb925089155.e0b3d670b033b1889366.js" async=""></script><script src="/_next/static/runtime/main-27122c53c6c061494a08.js" async=""></script><script src="/_next/static/chunks/4b5d35de3ec6426d4db57841c6c1b4b124768f5b.1cf5cae86f3d15225359.js" async=""></script><script src="/_next/static/LUWioLlLulu8RWrhGUiG9/_buildManifest.js" async=""></script><script src="/_next/static/LUWioLlLulu8RWrhGUiG9/_ssgManifest.js" async=""></script></body></html>