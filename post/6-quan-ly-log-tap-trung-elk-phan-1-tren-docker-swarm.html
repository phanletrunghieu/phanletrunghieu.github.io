<!DOCTYPE html><html><head><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap" rel="stylesheet"/><title>Quản lý log tập trung trong microservice với ELK. Phần 1: trên docker swarm - Hlog - Code for fun</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta charSet="utf-8"/><meta name="description" content="
## 1. Kiến trúc

![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/architect.png)

## 2. Khởi tạo docker swarm

Bạn có thể dùng nhiều server có cài sẵn docker để tạo thành 1 c"/><meta property="og:type" content="article"/><meta property="og:title" content="Quản lý log tập trung trong microservice với ELK. Phần 1: trên docker swarm - Hlog - Code for fun"/><meta property="og:description" content="
## 1. Kiến trúc

![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/architect.png)

## 2. Khởi tạo docker swarm

Bạn có thể dùng nhiều server có cài sẵn docker để tạo thành 1 c"/><meta property="og:image" content="https://phanletrunghieu.github.io/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/cover.jpg"/><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/8537a22d1fe977ad51c0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8537a22d1fe977ad51c0.css"/><link rel="preload" href="/_next/static/css/dcd1edf90b6e9b170e2b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dcd1edf90b6e9b170e2b.css"/><link rel="preload" href="/_next/static/sKZg9wc4WSl_RRI4none0/pages/post/%5Bslug%5D.js" as="script"/><link rel="preload" href="/_next/static/sKZg9wc4WSl_RRI4none0/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-b65cab0b00afd201cbda.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.2689030919a9ba0449ff.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.d3a5cad3addbd9214ed4.js" as="script"/><link rel="preload" href="/_next/static/chunks/c442d3f0a0361db8f160461f3f63f1c6cad761fd.e0b3d670b033b1889366.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-e0bd383e41250329b51a.js" as="script"/><link rel="preload" href="/_next/static/chunks/3cf62392100353b6e8be1014d666f3636d8d3857.1cf5cae86f3d15225359.js" as="script"/></head><body><div id="__next"><div><div><div class="Header_container__13qZs"><h2 class="Header_logo__1ZEvY">Hlog</h2><div><span class="Header_category__10c-V">ReactJS</span><span class="Header_category__10c-V">K8s</span><span class="Header_category__10c-V">Docker</span><span class="Header_category__10c-V">GI/CD</span><span class="Header_category__10c-V">Tip</span><span class="Header_category__10c-V">Gitlab</span><span class="Header_category__10c-V">Microservice</span></div><div></div></div><div style="margin-top:120px;margin-bottom:50px"><div class="Post_headerContainer__2SstR"><h1>Quản lý log tập trung trong microservice với ELK. Phần 1: trên docker swarm</h1><div class="Post_subHeader__2A2DV"><p class="Post_date__3SBQj">Jun 22 2020</p><span class="Post_readDuration__WqJgS">30 min</span></div></div><div style="background-image:url(/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/cover.jpg);background-size:cover;background-position:center;width:100%;height:0"></div><div class="Post_content__3ENjB"><h2>1. Kiến trúc</h2><p><img alt="List node" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/architect.png"/></p><h2>2. Khởi tạo docker swarm</h2><p>Bạn có thể dùng nhiều server có cài sẵn docker để tạo thành 1 cluster. Tốt nhất là docker cùng version để tránh gặp những lỗi tào lao. Trong bài viết này mình dùng docker-machine để giả lập 3 node để demo.</p><h3>2.1. Tạo 1 cluster với 3 node</h3><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker-machine create -d virtualbox --virtualbox-memory <span class="token" style="color:#690">&quot;2048&quot;</span> node1
docker-machine create -d virtualbox --virtualbox-memory <span class="token" style="color:#690">&quot;1024&quot;</span> node2
docker-machine create -d virtualbox --virtualbox-memory <span class="token" style="color:#690">&quot;1024&quot;</span> node3</code></pre><p>Fixing <code>out of memory</code> error of Elasticsearch</p><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker-machine <span class="token" style="color:#DD4A68">ssh</span> node1 <span class="token" style="color:#DD4A68">sudo</span> sysctl -w vm.max_map_count<span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span class="token" style="color:#905">262144</span>
docker-machine <span class="token" style="color:#DD4A68">ssh</span> node2 <span class="token" style="color:#DD4A68">sudo</span> sysctl -w vm.max_map_count<span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span class="token" style="color:#905">262144</span>
docker-machine <span class="token" style="color:#DD4A68">ssh</span> node3 <span class="token" style="color:#DD4A68">sudo</span> sysctl -w vm.max_map_count<span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span class="token" style="color:#905">262144</span></code></pre><p>Kiểm tra các node đã tạo</p><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker-machine <span class="token" style="color:#DD4A68">ls</span></code></pre><p><img alt="List node" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/1-list-node.png"/></p><h3>2.2. Cho <code>node1</code> làm node manager.</h3><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker-machine <span class="token" style="color:#DD4A68">ssh</span> node1
docker swarm init --advertise-addr <span class="token" style="color:#905">192.168</span>.99.104</code></pre><p><code>192.168.99.104</code> là ip của node 1, đã kiểm tra ở trên.</p><p><img alt="List node" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/2-init-swarm.png"/></p><p>Kết quả ở trên cho ta 1 command để các node khác có thể join vào cluster.</p><h3>2.3. Join các node còn lại vào cluster</h3><p>Ta lần lượt ssh vào từng node và chạy lệnh join ở trên.</p><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker-machine <span class="token" style="color:#DD4A68">ssh</span> node2
docker swarm <span class="token" style="color:#DD4A68">join</span> --token SWMTKN-1-5dk4ysohsctxbifjmb6x8xa5i6qps81au5k4fmzzqmne3l3oz0-ac99bh5vrw8zm3lychgpu3cwh <span class="token" style="color:#905">192.168</span>.99.104:2377</code></pre><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker-machine <span class="token" style="color:#DD4A68">ssh</span> node3
docker swarm <span class="token" style="color:#DD4A68">join</span> --token SWMTKN-1-5dk4ysohsctxbifjmb6x8xa5i6qps81au5k4fmzzqmne3l3oz0-ac99bh5vrw8zm3lychgpu3cwh <span class="token" style="color:#905">192.168</span>.99.104:2377</code></pre><blockquote><p>Chú ý: <code>token</code> trong lệnh <code>docker swarm join</code> sẽ khác nhau ở mỗi lần chạy. Nên chỗ này đừng copy của mình nhé. Lỗi đấy!</p></blockquote><h2>3. Deploy ELK lên docker swarm</h2><p>SSH vào node manager <code>docker-machine ssh node1</code>.</p><p>Tạo 1 file <code>docker-stack.yml</code> có nội dung như sau:</p><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token key" style="color:#07a">version</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">&#x27;3&#x27;</span>

<span class="token key" style="color:#07a">services</span><span class="token" style="color:#999">:</span>
  <span class="token key" style="color:#07a">elasticsearch</span><span class="token" style="color:#999">:</span>
    <span class="token key" style="color:#07a">image</span><span class="token" style="color:#999">:</span> docker.elastic.co/elasticsearch/elasticsearch<span class="token" style="color:#999">:</span>7.8.0
    <span class="token key" style="color:#07a">ports</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> <span class="token" style="color:#690">&quot;9200:9200&quot;</span>
    <span class="token key" style="color:#07a">volumes</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> esdata<span class="token" style="color:#999">:</span>/usr/share/elasticsearch/data
    <span class="token key" style="color:#07a">environment</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">ES_JAVA_OPTS</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">&quot;-Xmx256m -Xms256m&quot;</span>
      <span class="token key" style="color:#07a">ELASTIC_PASSWORD</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">&quot;changeme&quot;</span>
      <span class="token key" style="color:#07a">discovery.type</span><span class="token" style="color:#999">:</span> single<span class="token" style="color:#999">-</span>node
    <span class="token key" style="color:#07a">deploy</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">placement</span><span class="token" style="color:#999">:</span>
        <span class="token key" style="color:#07a">constraints</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#999">[</span>node.role == manager<span class="token" style="color:#999">]</span>

  <span class="token key" style="color:#07a">logstash</span><span class="token" style="color:#999">:</span>
    <span class="token key" style="color:#07a">image</span><span class="token" style="color:#999">:</span> docker.elastic.co/logstash/logstash<span class="token" style="color:#999">:</span>7.8.0
    <span class="token key" style="color:#07a">volumes</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> ./logstash.conf<span class="token" style="color:#999">:</span>/usr/share/logstash/pipeline/logstash.conf
    <span class="token key" style="color:#07a">depends_on</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> elasticsearch
    <span class="token key" style="color:#07a">deploy</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">placement</span><span class="token" style="color:#999">:</span>
        <span class="token key" style="color:#07a">constraints</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#999">[</span>node.role == manager<span class="token" style="color:#999">]</span>

  <span class="token key" style="color:#07a">kibana</span><span class="token" style="color:#999">:</span>
    <span class="token key" style="color:#07a">image</span><span class="token" style="color:#999">:</span> docker.elastic.co/kibana/kibana<span class="token" style="color:#999">:</span>7.8.0
    <span class="token key" style="color:#07a">environment</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">ELASTICSEARCH_HOSTS</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">&#x27;http://elasticsearch:9200&#x27;</span>
    <span class="token key" style="color:#07a">ports</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> <span class="token" style="color:#690">&quot;5601:5601&quot;</span>
    <span class="token key" style="color:#07a">depends_on</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> logstash
    <span class="token key" style="color:#07a">deploy</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">placement</span><span class="token" style="color:#999">:</span>
        <span class="token key" style="color:#07a">constraints</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#999">[</span>node.role == manager<span class="token" style="color:#999">]</span>

  <span class="token key" style="color:#07a">logspout</span><span class="token" style="color:#999">:</span>
    <span class="token key" style="color:#07a">image</span><span class="token" style="color:#999">:</span> gliderlabs/logspout<span class="token" style="color:#999">:</span>v3
    <span class="token key" style="color:#07a">command</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">&#x27;udp://logstash:5000&#x27;</span>
    <span class="token key" style="color:#07a">volumes</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> /var/run/docker.sock<span class="token" style="color:#999">:</span>/var/run/docker.sock
    <span class="token key" style="color:#07a">depends_on</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> logstash
    <span class="token key" style="color:#07a">deploy</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">mode</span><span class="token" style="color:#999">:</span> global
      <span class="token key" style="color:#07a">restart_policy</span><span class="token" style="color:#999">:</span>
        <span class="token key" style="color:#07a">condition</span><span class="token" style="color:#999">:</span> on<span class="token" style="color:#999">-</span>failure
        <span class="token key" style="color:#07a">delay</span><span class="token" style="color:#999">:</span> 30s

  <span class="token key" style="color:#07a">visualizer</span><span class="token" style="color:#999">:</span>
    <span class="token key" style="color:#07a">image</span><span class="token" style="color:#999">:</span> dockersamples/visualizer<span class="token" style="color:#999">:</span>stable
    <span class="token key" style="color:#07a">ports</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> <span class="token" style="color:#690">&quot;8081:8080&quot;</span>
    <span class="token key" style="color:#07a">volumes</span><span class="token" style="color:#999">:</span>
      <span class="token" style="color:#999">-</span> <span class="token" style="color:#690">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span>
    <span class="token key" style="color:#07a">labels</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">app</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">&quot;visualizer&quot;</span>
    <span class="token key" style="color:#07a">deploy</span><span class="token" style="color:#999">:</span>
      <span class="token key" style="color:#07a">placement</span><span class="token" style="color:#999">:</span>
        <span class="token key" style="color:#07a">constraints</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#999">[</span>node.role == manager<span class="token" style="color:#999">]</span>

<span class="token key" style="color:#07a">volumes</span><span class="token" style="color:#999">:</span>
  <span class="token key" style="color:#07a">esdata</span><span class="token" style="color:#999">:</span>
    <span class="token key" style="color:#07a">driver</span><span class="token" style="color:#999">:</span> local</code></pre><p>Tạo 1 file <code>logstash.conf</code> có nội dung như sau:</p><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">input {
   udp {
   		port =&gt; 5000
   		codec =&gt; json
   	}
}

## Add your filters / logstash plugins configuration here

filter {
  if [docker][image] =~ /logstash/ {
    drop { }
  }
}

output {
    elasticsearch {
      hosts =&gt; &quot;elasticsearch:9200&quot;
      user =&gt; &quot;elastic&quot;
      password =&gt; &quot;changeme&quot;
    }

    stdout { codec =&gt; rubydebug }
}</code></pre><p>Tiến hành deploy</p><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker stack deploy -c docker-stack.yml elk</code></pre><p>Thường mình sẽ gặp 1 lỗi là logspout sẽ không kết nối được đến logstash, do logstash chưa init xong. Bạn hãy đợi 1 thời gian rồi chạy <code>docker service update --force elk_logspout</code> để restart lại logspout trên các node.</p><h2>4. Xem log từ Kibana</h2><p>Dùng browser truy cập vào 1 node bất kỳ trong swarm với port <code>5601</code></p><p><img alt="List node" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/1-list-node.png"/></p><p>Trong trường hợp của mình, mình sẽ truy cập vào <code>http://192.168.99.104:5601</code>.</p><p><img alt="Kibana" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/3-kibana-1.jpg"/></p><p>Tạo 1 index pattern <code>logstash*</code>
<img alt="Kibana" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/4-kibana-2.jpg"/></p><p><img alt="Kibana" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/5-kibana-3.jpg"/></p><p><img alt="Kibana" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/6-kibana-4.jpg"/></p><p><img alt="Kibana" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/7-kibana-5.jpg"/></p><p><img alt="Kibana" src="/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/8-kibana-6.png"/></p><p>Oke! Tới đây giao diện để truy xuất log đã hiện ra. Bạn có thể filter log theo thời gian, theo app,... Chỗ này bạn có thể tự mò nhé, giao diện kibana cũng khá dễ sử dụng.</p></div><div class="Post_comments__v-xdT"><div><div class="fb-comments" data-href="https://phanletrunghieu.github.io/post/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm"></div></div></div></div><div><div class="Footer_content__3hdD7"><div class="Footer_logo__2F2BD">Hlog</div><div class="Footer_iconContainer__3ouva"><a target="_blank" href="https://github.com/phanletrunghieu"><svg class="Footer_logoSvg__XMKMu" data-prefix="fab" data-icon="github-square" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"></path></svg></a><a target="_blank" href="https://www.linkedin.com/in/phanletrunghieu"><svg class="Footer_logoSvg__XMKMu" data-prefix="fab" data-icon="linkedin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a target="_blank" href="https://www.facebook.com/phanletrunghieu"><svg class="Footer_logoSvg__XMKMu" data-prefix="fab" data-icon="facebook-square" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M400 32H48A48 48 0 0 0 0 80v352a48 48 0 0 0 48 48h137.25V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.27c-30.81 0-40.42 19.12-40.42 38.73V256h68.78l-11 71.69h-57.78V480H400a48 48 0 0 0 48-48V80a48 48 0 0 0-48-48z"></path></svg></a></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm","siteTitle":"Hlog - Code for fun","frontmatter":{"author":"Hieu Phan","date":"2020-06-22T15:22:00.000Z","image":"/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/cover.jpg","title":"Quản lý log tập trung trong microservice với ELK. Phần 1: trên docker swarm","readDuration":"30 min","categories":["Docker","Microservice"]},"markdownBody":"\n## 1. Kiến trúc\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/architect.png)\n\n## 2. Khởi tạo docker swarm\n\nBạn có thể dùng nhiều server có cài sẵn docker để tạo thành 1 cluster. Tốt nhất là docker cùng version để tránh gặp những lỗi tào lao. Trong bài viết này mình dùng docker-machine để giả lập 3 node để demo.\n\n### 2.1. Tạo 1 cluster với 3 node\n\n```bash\ndocker-machine create -d virtualbox --virtualbox-memory \"2048\" node1\ndocker-machine create -d virtualbox --virtualbox-memory \"1024\" node2\ndocker-machine create -d virtualbox --virtualbox-memory \"1024\" node3\n```\n\nFixing `out of memory` error of Elasticsearch\n\n```bash\ndocker-machine ssh node1 sudo sysctl -w vm.max_map_count=262144\ndocker-machine ssh node2 sudo sysctl -w vm.max_map_count=262144\ndocker-machine ssh node3 sudo sysctl -w vm.max_map_count=262144\n```\n\nKiểm tra các node đã tạo\n\n```bash\ndocker-machine ls\n```\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/1-list-node.png)\n\n### 2.2. Cho `node1` làm node manager.\n\n```bash\ndocker-machine ssh node1\ndocker swarm init --advertise-addr 192.168.99.104\n```\n\n`192.168.99.104` là ip của node 1, đã kiểm tra ở trên.\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/2-init-swarm.png)\n\nKết quả ở trên cho ta 1 command để các node khác có thể join vào cluster.\n\n### 2.3. Join các node còn lại vào cluster\n\nTa lần lượt ssh vào từng node và chạy lệnh join ở trên.\n\n```bash\ndocker-machine ssh node2\ndocker swarm join --token SWMTKN-1-5dk4ysohsctxbifjmb6x8xa5i6qps81au5k4fmzzqmne3l3oz0-ac99bh5vrw8zm3lychgpu3cwh 192.168.99.104:2377\n```\n\n```bash\ndocker-machine ssh node3\ndocker swarm join --token SWMTKN-1-5dk4ysohsctxbifjmb6x8xa5i6qps81au5k4fmzzqmne3l3oz0-ac99bh5vrw8zm3lychgpu3cwh 192.168.99.104:2377\n```\n\n\u003e Chú ý: `token` trong lệnh `docker swarm join` sẽ khác nhau ở mỗi lần chạy. Nên chỗ này đừng copy của mình nhé. Lỗi đấy!\n\n## 3. Deploy ELK lên docker swarm\n\nSSH vào node manager `docker-machine ssh node1`.\n\nTạo 1 file `docker-stack.yml` có nội dung như sau:\n\n```yaml\nversion: '3'\n\nservices:\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0\n    ports:\n      - \"9200:9200\"\n    volumes:\n      - esdata:/usr/share/elasticsearch/data\n    environment:\n      ES_JAVA_OPTS: \"-Xmx256m -Xms256m\"\n      ELASTIC_PASSWORD: \"changeme\"\n      discovery.type: single-node\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  logstash:\n    image: docker.elastic.co/logstash/logstash:7.8.0\n    volumes:\n      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf\n    depends_on:\n      - elasticsearch\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.8.0\n    environment:\n      ELASTICSEARCH_HOSTS: 'http://elasticsearch:9200'\n    ports:\n      - \"5601:5601\"\n    depends_on:\n      - logstash\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\n  logspout:\n    image: gliderlabs/logspout:v3\n    command: 'udp://logstash:5000'\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n    depends_on:\n      - logstash\n    deploy:\n      mode: global\n      restart_policy:\n        condition: on-failure\n        delay: 30s\n\n  visualizer:\n    image: dockersamples/visualizer:stable\n    ports:\n      - \"8081:8080\"\n    volumes:\n      - \"/var/run/docker.sock:/var/run/docker.sock\"\n    labels:\n      app: \"visualizer\"\n    deploy:\n      placement:\n        constraints: [node.role == manager]\n\nvolumes:\n  esdata:\n    driver: local\n```\n\nTạo 1 file `logstash.conf` có nội dung như sau:\n\n```\ninput {\n   udp {\n   \t\tport =\u003e 5000\n   \t\tcodec =\u003e json\n   \t}\n}\n\n## Add your filters / logstash plugins configuration here\n\nfilter {\n  if [docker][image] =~ /logstash/ {\n    drop { }\n  }\n}\n\noutput {\n    elasticsearch {\n      hosts =\u003e \"elasticsearch:9200\"\n      user =\u003e \"elastic\"\n      password =\u003e \"changeme\"\n    }\n\n    stdout { codec =\u003e rubydebug }\n}\n```\n\nTiến hành deploy\n\n```bash\ndocker stack deploy -c docker-stack.yml elk\n```\n\nThường mình sẽ gặp 1 lỗi là logspout sẽ không kết nối được đến logstash, do logstash chưa init xong. Bạn hãy đợi 1 thời gian rồi chạy `docker service update --force elk_logspout` để restart lại logspout trên các node.\n\n## 4. Xem log từ Kibana\n\nDùng browser truy cập vào 1 node bất kỳ trong swarm với port `5601`\n\n![List node](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/1-list-node.png)\n\nTrong trường hợp của mình, mình sẽ truy cập vào `http://192.168.99.104:5601`.\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/3-kibana-1.jpg)\n\nTạo 1 index pattern `logstash*`\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/4-kibana-2.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/5-kibana-3.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/6-kibana-4.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/7-kibana-5.jpg)\n\n![Kibana](/images/6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm/8-kibana-6.png)\n\nOke! Tới đây giao diện để truy xuất log đã hiện ra. Bạn có thể filter log theo thời gian, theo app,... Chỗ này bạn có thể tự mò nhé, giao diện kibana cũng khá dễ sử dụng.","categories":["ReactJS","K8s","Docker","GI/CD","Tip","Gitlab","Microservice"],"host":"https://phanletrunghieu.github.io"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"6-quan-ly-log-tap-trung-elk-phan-1-tren-docker-swarm"},"buildId":"sKZg9wc4WSl_RRI4none0","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-ac8b02fa82de57111615.js"></script><script async="" data-next-page="/post/[slug]" src="/_next/static/sKZg9wc4WSl_RRI4none0/pages/post/%5Bslug%5D.js"></script><script async="" data-next-page="/_app" src="/_next/static/sKZg9wc4WSl_RRI4none0/pages/_app.js"></script><script src="/_next/static/runtime/webpack-b65cab0b00afd201cbda.js" async=""></script><script src="/_next/static/chunks/framework.2689030919a9ba0449ff.js" async=""></script><script src="/_next/static/chunks/commons.d3a5cad3addbd9214ed4.js" async=""></script><script src="/_next/static/chunks/c442d3f0a0361db8f160461f3f63f1c6cad761fd.e0b3d670b033b1889366.js" async=""></script><script src="/_next/static/runtime/main-e0bd383e41250329b51a.js" async=""></script><script src="/_next/static/chunks/3cf62392100353b6e8be1014d666f3636d8d3857.1cf5cae86f3d15225359.js" async=""></script><script src="/_next/static/sKZg9wc4WSl_RRI4none0/_buildManifest.js" async=""></script><script src="/_next/static/sKZg9wc4WSl_RRI4none0/_ssgManifest.js" async=""></script></body></html>